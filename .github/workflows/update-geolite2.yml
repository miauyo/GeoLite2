name: Update GeoLite2 Databases

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å‘¨å›› 00:00 UTC
  schedule:
    - cron: '0 0 * * 4'
  
  # æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'
        type: boolean
      skip_cleanup:
        description: 'è·³è¿‡æ—§ç‰ˆæœ¬æ¸…ç†'
        required: false
        default: 'false'
        type: boolean

# å·¥ä½œæµæƒé™è®¾ç½®ï¼ˆæœ€å°å¿…è¦æƒé™åŸåˆ™ï¼‰
permissions:
  contents: write
  actions: read
  security-events: write

# ç¯å¢ƒå˜é‡
env:
  MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
jobs:
  update-geolite2:
    name: æ›´æ–° GeoLite2 æ•°æ®åº“
    runs-on: ubuntu-latest
    
    # è¶…æ—¶è®¾ç½®ï¼ˆ30åˆ†é’Ÿï¼‰
    timeout-minutes: 30
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      # 2. è®¾ç½®å·¥ä½œç¯å¢ƒ
      - name: è®¾ç½®å·¥ä½œç¯å¢ƒ
        run: |
          echo "ğŸš€ å¼€å§‹ GeoLite2 æ•°æ®åº“æ›´æ–°å·¥ä½œæµ"
          echo "ğŸ“… è§¦å‘æ—¶é—´: $(date -u)"
          echo "ğŸ”§ è¿è¡Œç¯å¢ƒ: ${{ runner.os }}"
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          mkdir -p downloads
          mkdir -p releases
          mkdir -p logs
          
          # è®¾ç½®æ—¥å¿—æ–‡ä»¶
          echo "LOG_FILE=logs/update-$(date +%Y%m%d-%H%M%S).log" >> $GITHUB_ENV
          
      # 3. éªŒè¯ MaxMind è®¸å¯è¯å¯†é’¥
      - name: éªŒè¯ MaxMind è®¸å¯è¯
        run: |
          if [ -z "$MAXMIND_LICENSE_KEY" ]; then
            echo "âŒ é”™è¯¯: MAXMIND_LICENSE_KEY æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub Secrets ä¸­è®¾ç½® MaxMind è®¸å¯è¯å¯†é’¥"
            exit 1
          fi
          echo "âœ… MaxMind è®¸å¯è¯å¯†é’¥å·²éªŒè¯"
          
      # 4. æµ‹è¯• MaxMind API è¿æ¥
      - name: æµ‹è¯• MaxMind API è¿æ¥
        run: |
          echo "ğŸ”— æµ‹è¯• MaxMind API è¿æ¥..."
          
          # æµ‹è¯•åŸºæœ¬è¿æ¥
          TEST_URL="https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country&license_key=$MAXMIND_LICENSE_KEY&suffix=tar.gz"
          
          echo "ğŸŒ æµ‹è¯•è¿æ¥åˆ° MaxMind æœåŠ¡å™¨..."
          HTTP_CODE=$(curl -s -I -w "%{http_code}" -o /dev/null "${TEST_URL}")
          
          echo "ğŸ“Š è¿æ¥æµ‹è¯•ç»“æœ: HTTP $HTTP_CODE"
          
          case $HTTP_CODE in
            200)
              echo "âœ… MaxMind API è¿æ¥æ­£å¸¸"
              ;;
            401|403)
              echo "âŒ è®¤è¯å¤±è´¥: è®¸å¯è¯å¯†é’¥æ— æ•ˆæˆ–æ— æƒé™"
              echo "ğŸ’¡ è¯·æ£€æŸ¥ GitHub Secrets ä¸­çš„ MAXMIND_LICENSE_KEY"
              exit 1
              ;;
            *)
              echo "âš ï¸ è¿æ¥å¼‚å¸¸ (HTTP $HTTP_CODE)ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
              ;;
          esac
          
      # 5. è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
      - name: è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
        id: current_version
        run: |
          # è·å–æœ€æ–°çš„ release ç‰ˆæœ¬
          LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "")
          
          if [ -z "$LATEST_RELEASE" ]; then
            echo "ğŸ“ æœªæ‰¾åˆ°ç°æœ‰ç‰ˆæœ¬ï¼Œè¿™æ˜¯é¦–æ¬¡è¿è¡Œ"
            echo "current_version=" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ å½“å‰ç‰ˆæœ¬: $LATEST_RELEASE"
            echo "current_version=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          fi
          
      # 6. æ£€æŸ¥ MaxMind æ•°æ®åº“ç‰ˆæœ¬
      - name: æ£€æŸ¥ MaxMind æ•°æ®åº“ç‰ˆæœ¬
        id: check_version
        run: |
          echo "ğŸ” æ£€æŸ¥ MaxMind æ•°æ®åº“ç‰ˆæœ¬..."
          
          # è·å– GeoLite2-Country æ•°æ®åº“çš„æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
          COUNTRY_URL="https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-Country&license_key=$MAXMIND_LICENSE_KEY&suffix=tar.gz"
          
          # ä¸‹è½½å¹¶æ£€æŸ¥ç‰ˆæœ¬
          curl -s -I "$COUNTRY_URL" > country_headers.txt
          
          # ä» Content-Disposition å¤´éƒ¨æå–ç‰ˆæœ¬ä¿¡æ¯
          CONTENT_DISP=$(grep -i "content-disposition" country_headers.txt || echo "")
          
          if [ -n "$CONTENT_DISP" ]; then
            # æå–æ—¥æœŸä½œä¸ºç‰ˆæœ¬å· (æ ¼å¼: YYYYMMDD)
            VERSION_DATE=$(echo "$CONTENT_DISP" | grep -oE '[0-9]{8}' | head -1)
            if [ -z "$VERSION_DATE" ]; then
              VERSION_DATE=$(date +%Y%m%d)
            fi
          else
            VERSION_DATE=$(date +%Y%m%d)
          fi
          
          NEW_VERSION="v$VERSION_DATE"
          echo "ğŸ“Š æ£€æµ‹åˆ°ç‰ˆæœ¬: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
          CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"
          FORCE_UPDATE="${{ github.event.inputs.force_update }}"
          
          if [ "$FORCE_UPDATE" = "true" ]; then
            echo "ğŸ”„ å¼ºåˆ¶æ›´æ–°æ¨¡å¼å·²å¯ç”¨"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          elif [ "$NEW_VERSION" != "$CURRENT_VERSION" ]; then
            echo "âœ… å‘ç°æ–°ç‰ˆæœ¬ï¼Œéœ€è¦æ›´æ–°"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi
          
      # 7. ä¸‹è½½ GeoLite2 æ•°æ®åº“
      - name: ä¸‹è½½ GeoLite2 æ•°æ®åº“
        if: steps.check_version.outputs.needs_update == 'true'
        id: download
        run: |
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½ GeoLite2 æ•°æ®åº“..."
          
          # éªŒè¯è®¸å¯è¯å¯†é’¥æ ¼å¼
          if [[ ! "$MAXMIND_LICENSE_KEY" =~ ^[A-Za-z0-9]{16}$ ]]; then
            echo "âš ï¸ è­¦å‘Š: MaxMind è®¸å¯è¯å¯†é’¥æ ¼å¼å¯èƒ½ä¸æ­£ç¡®"
            echo "è®¸å¯è¯å¯†é’¥é•¿åº¦: ${#MAXMIND_LICENSE_KEY}"
          fi
          
          # å®šä¹‰æ•°æ®åº“ç±»å‹
          DATABASES=("GeoLite2-ASN" "GeoLite2-Country")
          
          # åˆ›å»ºä¸‹è½½ç›®å½•å¹¶è®¾ç½®æƒé™
          mkdir -p downloads
          chmod 755 downloads
          
          # ä¸‹è½½æ¯ä¸ªæ•°æ®åº“
          for DB in "${DATABASES[@]}"; do
            echo "ğŸ“¥ ä¸‹è½½ $DB..."
            
            URL="https://download.maxmind.com/app/geoip_download?edition_id=$DB&license_key=$MAXMIND_LICENSE_KEY&suffix=tar.gz"
            
            # ä¸‹è½½æ–‡ä»¶å¹¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            echo "ğŸŒ ä¸‹è½½URL: ${URL%&license_key=*}&license_key=***"
            
            HTTP_CODE=$(curl -L -w "%{http_code}" -o "downloads/${DB}.tar.gz" "$URL")
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "âœ… $DB ä¸‹è½½æˆåŠŸ (HTTP $HTTP_CODE)"
              
              # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
              if [ ! -f "downloads/${DB}.tar.gz" ]; then
                echo "âŒ é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶ä¸å­˜åœ¨"
                exit 1
              fi
              
              DOWNLOAD_SIZE=$(stat -c%s "downloads/${DB}.tar.gz" 2>/dev/null || stat -f%z "downloads/${DB}.tar.gz" 2>/dev/null || echo "0")
              echo "ğŸ“Š ä¸‹è½½æ–‡ä»¶å¤§å°: $DOWNLOAD_SIZE å­—èŠ‚"
              
              if [ "$DOWNLOAD_SIZE" -lt 1000 ]; then
                echo "âŒ é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æ˜¯é”™è¯¯é¡µé¢"
                echo "ğŸ“„ æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
                head -n 10 "downloads/${DB}.tar.gz" || true
                exit 1
              fi
              
              # è§£å‹æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
              cd downloads
              mkdir -p "${DB}_temp"
              tar -xzf "${DB}.tar.gz" -C "${DB}_temp"
              
              # æŸ¥æ‰¾ .mmdb æ–‡ä»¶ï¼ˆæ”¯æŒå¤šå±‚ç›®å½•ç»“æ„ï¼‰
              echo "ğŸ” åœ¨ ${DB}_temp ä¸­æŸ¥æ‰¾ .mmdb æ–‡ä»¶..."
              find "${DB}_temp" -type f -name "*.mmdb" -exec ls -la {} \;
              
              MMDB_FILE=$(find "${DB}_temp" -type f -name "*.mmdb" | head -1)
              
              if [ -n "$MMDB_FILE" ] && [ -f "$MMDB_FILE" ]; then
                # å¤åˆ¶å¹¶é‡å‘½å .mmdb æ–‡ä»¶
                cp "$MMDB_FILE" "${DB}.mmdb"
                echo "âœ… $DB.mmdb æå–æˆåŠŸ"
                echo "ğŸ“ åŸå§‹æ–‡ä»¶è·¯å¾„: $MMDB_FILE"
                
                # éªŒè¯æ–‡ä»¶å¤§å°
                FILE_SIZE=$(stat -c%s "${DB}.mmdb" 2>/dev/null || stat -f%z "${DB}.mmdb" 2>/dev/null || echo "0")
                echo "ğŸ“Š æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
                
                if [ "$FILE_SIZE" -eq 0 ]; then
                  echo "âŒ é”™è¯¯: $DB.mmdb æ–‡ä»¶å¤§å°ä¸º0"
                  exit 1
                fi
              else
                echo "âŒ æœªæ‰¾åˆ° $DB çš„ .mmdb æ–‡ä»¶"
                echo "ğŸ“‚ ${DB}_temp ç›®å½•å†…å®¹:"
                find "${DB}_temp" -type f -exec ls -la {} \;
                exit 1
              fi
              
              # æ¸…ç†ä¸´æ—¶ç›®å½•
              rm -rf "${DB}_temp"
              rm -f "${DB}.tar.gz"
              
              cd ..
            else
              echo "âŒ $DB ä¸‹è½½å¤±è´¥ (HTTP $HTTP_CODE)"
              
              case $HTTP_CODE in
                401|403)
                  echo "ğŸ”‘ è®¤è¯å¤±è´¥: è¯·æ£€æŸ¥ MAXMIND_LICENSE_KEY æ˜¯å¦æ­£ç¡®"
                  echo "ğŸ’¡ æç¤º: ç¡®ä¿è®¸å¯è¯å¯†é’¥æœ‰æ•ˆä¸”å…·æœ‰ä¸‹è½½æƒé™"
                  ;;
                404)
                  echo "ğŸ“‚ æ–‡ä»¶ä¸å­˜åœ¨: $DB æ•°æ®åº“å¯èƒ½æš‚æ—¶ä¸å¯ç”¨"
                  ;;
                429)
                  echo "â° è¯·æ±‚è¿‡äºé¢‘ç¹: è¯·ç¨åé‡è¯•"
                  ;;
                500|502|503)
                  echo "ğŸ”§ æœåŠ¡å™¨é”™è¯¯: MaxMind æœåŠ¡å¯èƒ½æš‚æ—¶ä¸å¯ç”¨"
                  ;;
                *)
                  echo "ğŸŒ ç½‘ç»œé”™è¯¯: HTTPçŠ¶æ€ç  $HTTP_CODE"
                  ;;
              esac
              
              # æ˜¾ç¤ºå¯èƒ½çš„é”™è¯¯å“åº”å†…å®¹
              if [ -f "downloads/${DB}.tar.gz" ]; then
                echo "ğŸ“„ å“åº”å†…å®¹é¢„è§ˆ:"
                head -n 5 "downloads/${DB}.tar.gz" || true
              fi
              
              exit 1
            fi
          done
          
          echo "download_success=true" >> $GITHUB_OUTPUT
          
      # 8. æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ
      - name: æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ
        if: steps.download.outputs.download_success == 'true'
        run: |
          echo "ğŸ” æ‰§è¡Œæ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ..."
          
          cd downloads
          
          # ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶
          echo "# GeoLite2 æ•°æ®åº“æ–‡ä»¶æ ¡éªŒå’Œ" > checksums.txt
          echo "# ç”Ÿæˆæ—¶é—´: $(date -u)" >> checksums.txt
          echo "" >> checksums.txt
          
          for file in *.mmdb; do
            if [ -f "$file" ]; then
              echo "ğŸ” æ ¡éªŒ $file..."
              
              # ç”Ÿæˆ MD5 å’Œ SHA256
              MD5=$(md5sum "$file" | cut -d' ' -f1)
              SHA256=$(sha256sum "$file" | cut -d' ' -f1)
              
              echo "## $file" >> checksums.txt
              echo "MD5: $MD5" >> checksums.txt
              echo "SHA256: $SHA256" >> checksums.txt
              echo "" >> checksums.txt
              
              echo "âœ… $file æ ¡éªŒå®Œæˆ"
              echo "   MD5: $MD5"
              echo "   SHA256: $SHA256"
            fi
          done
          
          echo "âœ… æ‰€æœ‰æ–‡ä»¶æ ¡éªŒå®Œæˆ"
          
      # 9. å‹ç¼©å’Œæ‰“åŒ…
      - name: å‹ç¼©å’Œæ‰“åŒ…æ–‡ä»¶
        if: steps.download.outputs.download_success == 'true'
        run: |
          echo "ğŸ“¦ å¼€å§‹å‹ç¼©å’Œæ‰“åŒ…æ–‡ä»¶..."
          
          VERSION="${{ steps.check_version.outputs.new_version }}"
          ARCHIVE_NAME="GeoLite2-Databases-$VERSION"
          
          cd downloads
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p "../releases/$ARCHIVE_NAME"
          
          # å¤åˆ¶ .mmdb æ–‡ä»¶å’Œæ ¡éªŒå’Œæ–‡ä»¶
          cp *.mmdb "../releases/$ARCHIVE_NAME/"
          cp checksums.txt "../releases/$ARCHIVE_NAME/"
          
          # åˆ›å»º README æ–‡ä»¶
          cat > "../releases/$ARCHIVE_NAME/README.md" << EOF
          # GeoLite2 æ•°æ®åº“ $VERSION
          
          ## åŒ…å«çš„æ•°æ®åº“
          - **GeoLite2-ASN.mmdb**: ASN (è‡ªæ²»ç³»ç»Ÿå·) æ•°æ®åº“
          - **GeoLite2-Country.mmdb**: å›½å®¶çº§åœ°ç†ä½ç½®æ•°æ®åº“
          
          ## æ–‡ä»¶ä¿¡æ¯
          - ç‰ˆæœ¬: $VERSION
          - æ›´æ–°æ—¶é—´: $(date -u)
          - æ•°æ®æ¥æº: MaxMind GeoLite2
          
          ## ä½¿ç”¨è¯´æ˜
          è¿™äº›æ•°æ®åº“æ–‡ä»¶å¯ä»¥ä¸æ”¯æŒ MaxMind DB æ ¼å¼çš„åº”ç”¨ç¨‹åºä¸€èµ·ä½¿ç”¨ã€‚
          
          ## è®¸å¯è¯
          è¿™äº›æ•°æ®åº“åœ¨ MaxMind GeoLite2 è®¸å¯è¯ä¸‹æä¾›ã€‚
          è¯¦æƒ…è¯·å‚é˜…: https://dev.maxmind.com/geoip/geolite2-free-geolocation-data
          
          ## æ ¡éªŒå’Œ
          è¯·å‚é˜… checksums.txt æ–‡ä»¶ä»¥éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ã€‚
          EOF
          
          cd "../releases"
          
          # åˆ›å»º tar.gz å½’æ¡£
          tar -czf "${ARCHIVE_NAME}.tar.gz" "$ARCHIVE_NAME"
          
          # åˆ›å»º zip å½’æ¡£
          zip -r "${ARCHIVE_NAME}.zip" "$ARCHIVE_NAME"
          
          # å¤åˆ¶å•ç‹¬çš„ mmdb æ–‡ä»¶åˆ° releases ç›®å½•
          echo "ğŸ“‹ å¤åˆ¶å•ç‹¬çš„ mmdb æ–‡ä»¶..."
          cp "$ARCHIVE_NAME"/*.mmdb ./
          
          # åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ–‡ä»¶
          echo "ğŸ“ å¯ç”¨æ–‡ä»¶åˆ—è¡¨:"
          ls -la *.mmdb *.tar.gz *.zip
          
          echo "âœ… å½’æ¡£æ–‡ä»¶å’Œå•ç‹¬æ–‡ä»¶åˆ›å»ºå®Œæˆ:"
          echo "   ğŸ“¦ ${ARCHIVE_NAME}.tar.gz"
          echo "   ğŸ“¦ ${ARCHIVE_NAME}.zip"
          echo "   ğŸ“„ å•ç‹¬çš„ .mmdb æ–‡ä»¶:"
          for mmdb in *.mmdb; do
            echo "      ğŸ“„ $mmdb"
          done
          
          # è®¡ç®—æ–‡ä»¶å¤§å°
          TAR_SIZE=$(du -h "${ARCHIVE_NAME}.tar.gz" | cut -f1)
          ZIP_SIZE=$(du -h "${ARCHIVE_NAME}.zip" | cut -f1)
          
          echo "ğŸ“Š æ–‡ä»¶å¤§å°:"
          echo "   tar.gz: $TAR_SIZE"
          echo "   zip: $ZIP_SIZE"
          for mmdb in *.mmdb; do
            MMDB_SIZE=$(du -h "$mmdb" | cut -f1)
            echo "   $mmdb: $MMDB_SIZE"
          done
          
      # 10. åˆ›å»º GitHub Release
      - name: åˆ›å»º GitHub Release
        if: steps.download.outputs.download_success == 'true'
        id: create_release
        run: |
          echo "ğŸš€ åˆ›å»º GitHub Release..."
          
          VERSION="${{ steps.check_version.outputs.new_version }}"
          ARCHIVE_NAME="GeoLite2-Databases-$VERSION"
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          cat > release_notes.md << EOF
          # GeoLite2 æ•°æ®åº“æ›´æ–° $VERSION
          
          ## ğŸ“Š æ•°æ®åº“ä¿¡æ¯
          - **ç‰ˆæœ¬**: $VERSION
          - **æ›´æ–°æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **æ•°æ®æ¥æº**: MaxMind GeoLite2 å…è´¹åœ°ç†ä½ç½®æ•°æ®
          
          ## ğŸ“¦ åŒ…å«çš„æ•°æ®åº“
          - **GeoLite2-ASN.mmdb** - ASN (è‡ªæ²»ç³»ç»Ÿå·) æ•°æ®åº“
          - **GeoLite2-Country.mmdb** - å›½å®¶çº§åœ°ç†ä½ç½®æ•°æ®åº“
          
          ## ğŸ“¥ ä¸‹è½½é€‰é¡¹
          - **tar.gz æ ¼å¼**: é€‚ç”¨äº Linux/macOS ç³»ç»Ÿï¼ŒåŒ…å«æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶
          - **zip æ ¼å¼**: é€‚ç”¨äº Windows ç³»ç»Ÿï¼ŒåŒ…å«æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶
          - **å•ç‹¬ .mmdb æ–‡ä»¶**: ç›´æ¥ä¸‹è½½å•ä¸ªæ•°æ®åº“æ–‡ä»¶ï¼Œé€‚ç”¨äºåªéœ€è¦ç‰¹å®šæ•°æ®åº“çš„åœºæ™¯
          
          ## ğŸ” æ–‡ä»¶å®Œæ•´æ€§
          æ¯ä¸ªä¸‹è½½åŒ…éƒ½åŒ…å« \`checksums.txt\` æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶çš„ MD5 å’Œ SHA256 æ ¡éªŒå’Œã€‚
          
          ## ğŸ“ ä½¿ç”¨è¯´æ˜
          
          ### ä½¿ç”¨å½’æ¡£æ–‡ä»¶ (æ¨è)
          1. ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿçš„å½’æ¡£æ–‡ä»¶ (.tar.gz æˆ– .zip)
          2. è§£å‹ç¼©æ–‡ä»¶
          3. ä½¿ç”¨ \`checksums.txt\` éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
          4. å°† .mmdb æ–‡ä»¶éƒ¨ç½²åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºä¸­
          
          ### ä½¿ç”¨å•ç‹¬çš„ .mmdb æ–‡ä»¶
          1. ç›´æ¥ä¸‹è½½æ‰€éœ€çš„ .mmdb æ–‡ä»¶ (å¦‚ GeoLite2-Country.mmdb)
          2. å°†æ–‡ä»¶éƒ¨ç½²åˆ°æ‚¨çš„åº”ç”¨ç¨‹åºä¸­
          3. æ³¨æ„ï¼šå•ç‹¬ä¸‹è½½çš„æ–‡ä»¶æ— æ³•ä½¿ç”¨ checksums.txt éªŒè¯å®Œæ•´æ€§
          
          ## ğŸ”— ç›¸å…³é“¾æ¥
          - [MaxMind GeoLite2 æ–‡æ¡£](https://dev.maxmind.com/geoip/geolite2-free-geolocation-data)
          - [MaxMind DB æ ¼å¼è§„èŒƒ](https://maxmind.github.io/MaxMind-DB/)
          
          ---
          
          > æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆå’Œå‘å¸ƒ
          EOF
          
          # åˆ›å»º release å¹¶ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
          gh release create "$VERSION" \
            --title "GeoLite2 æ•°æ®åº“ $VERSION" \
            --notes-file release_notes.md \
            --latest \
            "releases/${ARCHIVE_NAME}.tar.gz" \
            "releases/${ARCHIVE_NAME}.zip" \
            releases/*.mmdb
          
          echo "âœ… GitHub Release åˆ›å»ºæˆåŠŸ: $VERSION"
          echo "release_created=true" >> $GITHUB_OUTPUT
          
      # 11. æ¸…ç†æ—§ç‰ˆæœ¬
      - name: æ¸…ç†æ—§ç‰ˆæœ¬
        if: steps.create_release.outputs.release_created == 'true' && github.event.inputs.skip_cleanup != 'true'
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬ Release..."
          
          # è·å–æ‰€æœ‰ releasesï¼ŒæŒ‰åˆ›å»ºæ—¶é—´æ’åº
          RELEASES=$(gh release list --json tagName,createdAt --jq 'sort_by(.createdAt) | reverse | .[3:] | .[].tagName')
          
          if [ -n "$RELEASES" ]; then
            echo "ğŸ“ å‘ç°éœ€è¦æ¸…ç†çš„æ—§ç‰ˆæœ¬:"
            echo "$RELEASES"
            
            # åˆ é™¤æ—§ç‰ˆæœ¬
            for release in $RELEASES; do
              echo "ğŸ—‘ï¸ åˆ é™¤ç‰ˆæœ¬: $release"
              gh release delete "$release" --yes
            done
            
            echo "âœ… æ—§ç‰ˆæœ¬æ¸…ç†å®Œæˆ"
          else
            echo "â„¹ï¸ æ— éœ€æ¸…ç†ï¼Œç‰ˆæœ¬æ•°é‡æœªè¶…è¿‡é™åˆ¶"
          fi
          
      # 12. æ¸…ç†æ•æ„Ÿæ•°æ®å’Œä¸´æ—¶æ–‡ä»¶
      - name: æ¸…ç†æ•æ„Ÿæ•°æ®
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†æ•æ„Ÿæ•°æ®å’Œä¸´æ—¶æ–‡ä»¶..."
          
          # æ¸…ç†ä¸‹è½½çš„æ–‡ä»¶
          rm -rf downloads/
          rm -rf releases/
          rm -f country_headers.txt
          rm -f release_notes.md
          
          # æ¸…ç†ç¯å¢ƒå˜é‡ä¸­çš„æ•æ„Ÿä¿¡æ¯
          unset MAXMIND_LICENSE_KEY
          
          echo "âœ… æ¸…ç†å®Œæˆ"
          
      # 13. å·¥ä½œæµçŠ¶æ€é€šçŸ¥
      - name: å·¥ä½œæµçŠ¶æ€é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ GeoLite2 æ•°æ®åº“æ›´æ–°å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ!"
            echo "âœ… çŠ¶æ€: æˆåŠŸ"
            if [ "${{ steps.check_version.outputs.needs_update }}" = "true" ]; then
              echo "ğŸ“¦ æ–°ç‰ˆæœ¬: ${{ steps.check_version.outputs.new_version }}"
              echo "ğŸ”— Release é“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.check_version.outputs.new_version }}"
            else
              echo "â„¹ï¸ æ— éœ€æ›´æ–°ï¼Œå·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            fi
          else
            echo "âŒ GeoLite2 æ•°æ®åº“æ›´æ–°å·¥ä½œæµæ‰§è¡Œå¤±è´¥!"
            echo "âŒ çŠ¶æ€: å¤±è´¥"
            echo "ğŸ“ è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          fi
          
          echo "â° æ‰§è¡Œæ—¶é—´: $(date -u)"
          echo "ğŸ”§ è¿è¡Œç¯å¢ƒ: ${{ runner.os }}"
          echo "ğŸ“Š å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ğŸ”— è¿è¡Œé“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"